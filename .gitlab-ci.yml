stages:
- dependencies
- pre-scripts
# - test
- build_apk

image: node:8.17.0


install_dependencies:
    stage: dependencies
    
    script:
    - npm install
    
    artifacts:
        paths:
        - node_modules/

        
run_pre-scripts :
    stage: pre-scripts
    
    dependencies:
    - install_dependencies
    
    script:
    - apt-get update
    - apt-get install -y gettext-base
    
    - mv app/config/keys.sample.js app/config/keys.js
        
    - 'touch ./android/app/google-services.json && echo $GOOGLE_SERVICES > ./android/app/google-services.json'
    
    - chmod +x ./scripts/fixes.sh
    - ./scripts/fixes.sh
    
    - chmod +x ./scripts/set_keys.sh
    - ./scripts/set_keys.sh
    
    - rm -rf android/app/build
    
    artifacts:
        paths:
        - android/
        - app/
        - node_modules/
        
# unit_test:
#     stage: test
    
#     dependencies:
#     - run_pre-scripts
    
#     script:
#     - npm test 

build_job:
    stage: build_apk
    image: reactnativecommunity/react-native-android
    
    dependencies:
    - run_pre-scripts

    script:
    - cd android && ./gradlew assembleDebug --stacktrace
    - mv ./app/build/outputs/apk/debug/app-debug.apk ../app-debug.apk

    artifacts:
        paths:
        - app-debug.apk
